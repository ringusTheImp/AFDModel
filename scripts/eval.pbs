#!/bin/bash
#PBS -N wx-afd-eval
#PBS -A <PROJECT_CODE>
#PBS -q develop
#PBS -l walltime=02:00:00
#PBS -l select=1:ncpus=8:ngpus=1
#PBS -j oe
#PBS -o /glade/derecho/scratch/$USER/wx-afd/logs/eval.log

module purge
module load ncarenv/23.09 cuda/12.2.1 conda
conda activate wx-afd

export TMPDIR=/glade/derecho/scratch/$USER/tmpdir
mkdir -p $TMPDIR

cd /glade/derecho/scratch/$USER/wx-afd

echo "=========================================="
echo "  WX-AFD Evaluation â€” $(date)"
echo "=========================================="

MERGED_MODEL=/glade/derecho/scratch/$USER/wx-afd/output/merged
VAL_DATA=/glade/derecho/scratch/$USER/wx-afd/data/val.jsonl
BASE_MODEL=Qwen/Qwen3-4B-Instruct-2507

# 1. Evaluate fine-tuned model
echo ""
echo ">>> Evaluating fine-tuned model..."
python scripts/evaluate.py \
    --model "$MERGED_MODEL" \
    --val_data "$VAL_DATA" \
    --tag finetuned \
    --output_dir eval/finetuned

# 2. Evaluate zero-shot baseline
echo ""
echo ">>> Evaluating zero-shot baseline..."
python scripts/evaluate.py \
    --model "$BASE_MODEL" \
    --val_data "$VAL_DATA" \
    --tag zero-shot \
    --output_dir eval/zero-shot

# 3. Print comparison
echo ""
echo "=========================================="
echo "  Comparison"
echo "=========================================="
python -c "
import json
ft = json.load(open('eval/finetuned/scores/metrics.json'))
zs = json.load(open('eval/zero-shot/scores/metrics.json'))
print(f'{\"Metric\":<20} {\"Fine-tuned\":>12} {\"Zero-shot\":>12} {\"Delta\":>12}')
print('-' * 58)
for k in ['rouge1', 'rouge2', 'rougeL', 'bertscore_f1', 'format_compliance']:
    f, z = ft[k], zs[k]
    d = f - z
    sign = '+' if d > 0 else ''
    print(f'{k:<20} {f:>12.4f} {z:>12.4f} {sign}{d:>11.4f}')
"

echo ""
echo "Evaluation complete at $(date)."
